Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Filename: monovideo4.asm
                           A     2    ; Author: Koen van Vliet <8by8mail@gmail.com>
                           A     3    ; Description: Test with monochrome video using
                           B     0    include "ez8.inc"
                           B     1    ;**********************************************
                           B     2    ;*  Copyright (C) 1999-2006 by  Zilog, Inc.
                           B     3    ;*  All Rights Reserved
                           B     4    ;**********************************************
                           B     5    
                           B   955    	.list on
                           B   956    
                           B   957    
                           A     5    ; Setup video generator
     017D7840              A     6    		sysFreq		equ		25_000_000;20_000_0
     00000032              A     7    		rFreq		equ		50
                           A     8    
     00000014              A     9    		hChars		equ		20			; Chara
     0000001E              A    10    		vChars		equ		30			; Chara
     00000002              A    11    		hBorderL	equ		2			; Left 
     00000002              A    12    		hBorderR	equ		2			; Right
     00000008              A    13    		cWidth		equ		8			; Width
     00000008              A    14    		cHeight		equ		8			; Heigh
                           A    15    
     00000002              A    16    		spiPre		equ	2
                           A    17    
                           B     0    include "monovideo4.inc"
                           B     1    ; Calculate timing parameters
     00000006              B     2    		leftChars	equ	6
     00000002              B     3    		rightChars	equ 2
     0000001C              B     4    		hCharsTotal equ	hChars + leftChars + ri
                           B     5    		if (hCharsTotal / 2) * 2 < hCharsTotal
                           B     6    			error "Horizontal characters must b
                           B     7    		endif
                           B     8    		
                           B     9    		if rFreq = 50
     00000040              B    10    			hTime		equ		64
     00000004              B    11    			hSyncTime	equ		4
     00000004              B    12    			bPorchTime	equ		4
     00000002              B    13    			fPorchTime	equ		2
     00000005              B    14    			vSyncHLines	equ		5
     00000001              B    15    			vSyncPad	equ		1;1
     00000120              B    16    			vLines		equ		288
                           B    17    		elseif rFreq = 60
                           B    18    			hTime		equ		63
                           B    19    			hSyncTime	equ		4
                           B    20    			bPorchTime	equ		4
                           B    21    			fPorchTime	equ		2
                           B    22    			vSyncHLines	equ		6
                           B    23    			vSyncPad	equ		0
                           B    24    			vLines		equ		240
                           B    25    		else
                           B    26    			error	"Unknown frequency"
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   2


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.inc
                           B    27    		endif
                           B    28    
     00000039              B    29    		t0Interval		var		hTime * sysFreq
     00000064              B    30    		t1hSync			var		(hSyncTime * sy
                           B    31    		;t1hSync			var		t1hSync / 4
     000002BA              B    32    		t1BroadSync		var		((t0Interval * 
                           B    33    		;t1BroadSync		var		t1BroadSync
                           B    34    
                           B    35    		;if t0Interval < (cWidth + 1) * spiPre 
                           B    36    		if hCharsTotal > (hTime * 25) / ((cWidt
                           B    37    			error "hCharsTotal:Horizontal chara
                           B    38    		endif
                           B    39    		
                           B    40    		if t1hSync > 255
                           B    41    		;	error "t1hSync:System clock frequen
                           B    42    		endif
                           B    43    		
                           B    44    		if t1BroadSync > 255
                           B    45    		;	error "t1BroadSync:System clock fre
                           B    46    		endif
                           B    47    		
                           B    48    ;Register labels (R4-R8 are free to use)
     00000001              B    49    		DDR			equ		1
     00000002              B    50    		AF			equ		2
                           B    51    
                           B    52    		vBuff		equ		RR10
                           B    53    		vBuffH		equ		R10
                           B    54    		vBuffL		equ		R11
                           B    55    		isrVect		equ		RR14
                           B    56    		isrVectH	equ		R14
                           B    57    		isrVectL	equ		R15
                           B    58    		hCharCnt	equ		R12
                           B    59    		vLineCnt	equ		R13
                           B    60    		state		equ		R9
     00000010              B    61    		lineBuff	equ		10h					     00000024              B    62    		userVars	equ		lineBuff + hChars	                           B    63    		
                           B    64    		
     00000200              B    65    		screenBuff	equ		200h
                           A    19    
0002 0200                  A    20    vector	RESET = init
000C 0298                  A    21    vector timer0 = isrT0
                           A    22    org 0200h
0200 8F                    A    23    init		di									0201 0100                  A    24    			srp		#00h						0203 E9000FFE              A    25    			ldx		SPH,#00h					0207 E9FF0FFF              A    26    			ldx		SPL,#FFh
020B 6C02                  A    27    			ld		R6,#2
020D D6 027F               A    28    			call	clrBuff						                           A    29    			
0210 E9010FD8              A    30    initSpi		ldx		PCADDR,#DDR					0214 E9EF0FD9              A    31    			ldx		PCCTL,#~(1<<4)
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   3


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
0218 E9020FD8              A    32    			ldx		PCADDR,#AF					021C E9100FD9              A    33    			ldx		PCCTL,#(1<<4)				0220 E9030F61              A    34    			ldx		SPICTL,#(1<<1)|(1<<0)		0224 E9000F63              A    35    			ldx		SPIMODE,#((cWidth & 7) << 2
0228 E9000F66              A    36    			ldx		SPIBRH,#HIGH(spiPre)		022C E9020F67              A    37    			ldx		SPIBRL,#LOW(spiPre)
                           A    38    
0230 E9000F07              A    39    			ldx		T0CTL1,#0					0234 E9000F06              A    40    			ldx		T0CTL0,#0					0238 E9000F02              A    41    			ldx		T0RH,#HIGH(t0Interval)		023C E9390F03              A    42    			ldx		T0RL,#LOW(t0Interval)		0240 E9010F07              A    43    			ldx		T0CTL1,#(1<<0)				0244 E9200FC1              A    44    			ldx		IRQ0ENH,#(1<<5)				0248 E9200FC2              A    45    			ldx		IRQ0ENL,#(1<<5)
                           A    46    			
024C E9000F0F              A    47    			ldx		T1CTL1,#0					0250 E9000F0E              A    48    			ldx		T1CTL0,#0					0254 E9000F0A              A    49    			ldx		T1RH,#HIGH(t1hSync)			0258 E9640F0B              A    50    			ldx		T1RL,#LOW(t1hSync)
025C E9400F0F              A    51    			ldx		T1CTL1,#(1<<6)				                           A    52    
0260 E9020FD8              A    53    initGPIO	ldx		PCADDR,#AF					0264 49020FD9              A    54    			orx		PCCTL,#(1<<1)			
                           A    55    			
0268 4CEF                  A    56    startVideo	ld		R4,#EFh
026A 5C23                  A    57    			ld		R5,#23h
026C 6C19                  A    58    			ld		R6,#19h
026E 9C 5D                 A    59    			ld		state,#LOW(preEq)			0270 CC06                  A    60    			ld		hCharCnt,#hCharsTotal/2 - l
0272 DC06                  A    61    			ld		vLineCnt,#vSyncHLines + vSy
0274 EC 03                 A    62    			ld		isrVectH,#HIGH(sync)
0276 FC 00                 A    63    			ld		isrVectL,#LOW(sync)
0278 49800F07              A    64    			orx		T0CTL1,#(1<<7)				027C 9F                    A    65    			ei									                           A    66    			
027D                       A    67    $$			; Do stuff
027D 8B FE                 A    68    			jr		$B
                           A    69    
027F 0C02                  A    70    clrBuff		ld		R0,#HIGH(screenBuff)
0281 1C00                  A    71    			ld		R1,#LOW(screenBuff)
0283 E4E1E2                A    72    $$			ld		R2,R1
0286 56E23F                A    73    			and		R2,#63
0289 96E2E0                A    74    			ldx		@RR0,R2
028C A0E0                  A    75    			incw	RR0
028E A6E158                A    76    			cp		R1,#LOW(screenBuff+hChars*v
0291 1FA6E004              A    77    			cpc		R0,#HIGH(screenBuff+hChars*
0295 EB EC                 A    78    			jr		ne,$B
0297 AF                    A    79    			ret
                           A    80    
0298 C4EE                  A    81    isrT0		jp		@isrVect
                           A    82    
                           A    83    align 256
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   4


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
0300                       A    84    sync
0300 DA 06                 A    85    backPorch	djnz	vLineCnt,$F					0302 9C 9E                 A    86    			ld		state,#LOW(vertPad2)		0304 E4E6ED                A    87    			ld		vLineCnt,R6
0307 BF                    A    88    			iret
0308 FC 11                 A    89    $$			ld		isrVectL,#LOW(backBor1)
030A 26E314                A    90    			sub		R3,#hChars					030D 36E200                A    91    			sbc		R2,#0
0310 BF                    A    92    			iret
                           A    93    
0311 E4EDE0                A    94    backBor1	ld		R0,vLineCnt
0314 56E007                A    95    			and		R0,#07h
0317 EB 52                 A    96    			jr		ne,$F						0319 06E314                A    97    			add		R3,#hChars					031C 16E200                A    98    			adc		R2,#0
031F A0E2                  A    99    			incw	RR2							                           A   100    
0321 FC 24                 A   101    			ld		isrVectL,#LOW(hSync)
0323 BF                    A   102    			iret
                           A   103    			
0324 59BF0F0F              A   104    hSync		andx	T1CTL1,#~(1<<6)				0328 49800F0F              A   105    			orx		T1CTL1,#(1<<7)				032C 49400F0F              A   106    			orx		T1CTL1,#(1<<6)
0330 FC 43                 A   107    			ld		isrVectL,#LOW(frontPorch)
0332 BF                    A   108    			iret
0333 59BF0F0F              A   109    doVSync		andx	T1CTL1,#~(1<<6)				0337 49800F0F              A   110    			orx		T1CTL1,#(1<<7)				033B 49400F0F              A   111    			orx		T1CTL1,#(1<<6)
033F E4E9EF                A   112    			ld		isrVectL,state
0342 BF                    A   113    			iret
                           A   114    
0343 FC 48                 A   115    frontPorch	ld		isrVectL,#LOW(frontBor1)
0345 BCFF                  A   116    			ld		vBuffL,#FFh					0347 BF                    A   117    			iret
0348 FC 4D                 A   118    frontBor1	ld		isrVectL,#LOW(frontBor2)
034A BCFF                  A   119    			ld		vBuffL,#FFh
034C BF                    A   120    			iret
034D FC 52                 A   121    frontBor2	ld		isrVectL,#LOW(frontBor3)
034F BCFF                  A   122    			ld		vBuffL,#FFh
0351 BF                    A   123    			iret
0352 FC 57                 A   124    frontBor3	ld		isrVectL,#LOW(frontBor4)
0354 BCFF                  A   125    			ld		vBuffL,#FFh
0356 BF                    A   126    			iret
0357 E4E9EF                A   127    frontBor4	ld		isrVectL,state
035A BCFF                  A   128    			ld		vBuffL,#FFh
035C BF                    A   129    			iret
                           A   130    			
                           A   131    ; Pre-equalizing pulses
035D CA 10                 A   132    preEq		djnz	hCharCnt,preEqEnd
035F DA 0A                 A   133    			djnz	vLineCnt,$F
0361 9C 70                 A   134    			ld		state,#LOW(vertPad)			0363 E4E5ED                A   135    			ld		vLineCnt,R5
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   5


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
0366 CC14                  A   136    			ld		hCharCnt,#hChars
0368 FC 00                 A   137    			ld		isrVectL,#LOW(sync)
036A BF                    A   138    			iret
036B CC0D                  A   139    $$			ld		hCharCnt,#hCharsTotal/2 - 1
036D FC 33                 A   140    			ld		isrVectL,#LOW(doVSync)
036F BF                    A   141    preEqEnd	iret
                           A   142    
                           A   143    ; Vertical padding
0370 CA 10                 A   144    vertPad		djnz	hCharCnt,vertPadEnd
0372 CC14                  A   145    			ld		hCharCnt,#hChars
0374 FC 00                 A   146    			ld		isrVectL,#LOW(sync)
0376 DA 06                 A   147    			djnz	vLineCnt,$F
0378 9C 83                 A   148    			ld		state,#LOW(fetch)			037A E4E4ED                A   149    			ld		vLineCnt,R4
037D BF                    A   150    			iret
037E 2C02                  A   151    $$			ld		R2,#HIGH(screenBuff + hChar
0380 3C14                  A   152    			ld		R3,#LOW(screenBuff + hChars
0382 BF                    A   153    vertPadEnd	iret
                           A   154    
                           A   155    
                           A   156    
                           A   157    ; Visible display
0383 94BF60                A   158    fetch		ldx		SPIDATA,vBuffL
0386 CA 05                 A   159    			djnz	hCharCnt,fetchTile			0388 CC14                  A   160    			ld		hCharCnt,#hChars
038A FC 00                 A   161    			ld		isrVectL,#LOW(sync)
038C BF                    A   162    			iret
038D E4EDE0                A   163    fetchTile	ld		R0,vLineCnt
0390 56E007                A   164    			and		R0,#07h						0393 46E0 00               A   165    			or		R0,#HIGH(charSet)			0396 86E2E1                A   166    			ldx		R1,@RR2						0399 A0E2                  A   167    			incw	RR2							039B C2B0                  A   168    			ldc		vBuffL,@RR0					                           A   169    			;ld		vBuffL,vLineCnt
                           A   170    			;ld		vBuffL,#00h					039D BF                    A   171    			iret
                           A   172    
                           A   173    			
                           A   174    			
                           A   175    ; Vertical padding bottom
039E CA 0D                 A   176    vertPad2	djnz	hCharCnt,vertPad2End
03A0 FC 33                 A   177    			ld		isrVectL,#LOW(doVSync)
03A2 DA 07                 A   178    			djnz	vLineCnt,$F
03A4 9C AE                 A   179    			ld		state,#LOW(postEq)			03A6 DC05                  A   180    			ld		vLineCnt,#vSyncHLines
03A8 CC0D                  A   181    			ld		hCharCnt,#hCharsTotal/2 - 1
03AA BF                    A   182    			iret
03AB CC14                  A   183    $$			ld		hCharCnt,#hChars
03AD BF                    A   184    vertPad2End	iret
                           A   185    
                           A   186    ; Post-equalizing pulses
03AE CA 12                 A   187    postEq		djnz	hCharCnt,postEqEnd
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     23:12:16     page:   6


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
03B0 DA 0C                 A   188    			djnz	vLineCnt,$F
03B2 9C C3                 A   189    			ld		state,#LOW(vSync)			03B4 DC05                  A   190    			ld		vLineCnt,#vSyncHLines
03B6 E9020F0A              A   191    			ldx		T1RH,#HIGH(t1BroadSync)		03BA E9BA0F0B              A   192    			ldx		T1RL,#LOW(t1BroadSync)
03BE CC0D                  A   193    $$			ld		hCharCnt,#hCharsTotal/2 - 1
03C0 FC 33                 A   194    			ld		isrVectL,#LOW(doVSync)
03C2 BF                    A   195    postEqEnd	iret
                           A   196    ; Broad sync pulses
03C3 CA 12                 A   197    vSync		djnz	hCharCnt,vSyncEnd
03C5 DA 0C                 A   198    			djnz	vLineCnt,$F
03C7 9C 5D                 A   199    			ld		state,#LOW(preEq)			03C9 DC06                  A   200    			ld		vLineCnt,#vSyncHLines + vSy
03CB E9000F0A              A   201    			ldx		T1RH,#HIGH(t1hSync)			03CF E9640F0B              A   202    			ldx		T1RL,#LOW(t1hSync)
03D3 CC0D                  A   203    $$			ld		hCharCnt,#hCharsTotal/2 - 1
03D5 FC 33                 A   204    			ld		isrVectL,#LOW(doVSync)
03D7 BF                    A   205    vSyncEnd	iret
                           A   206    
                           A   207    
                           A   208    if vSync - sync > 200
-----WARNING (507) Unexpected relocatable boolean/relational operand(s)
                           A   209    	warning "vSync label almost out of reach!"	                           A   210    endif											                           A   211    			
                           A   212    xref charSet


Errors: 0
Warnings: 1
Lines Assembled: 2387
