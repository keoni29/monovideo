Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Filename: monovideo4.asm
                           A     2    ; Author: Koen van Vliet <8by8mail@gmail.com>
                           A     3    ; Description: Test with monochrome video using
                           B     0    include "ez8.inc"
                           B     1    ;**********************************************
                           B     2    ;*  Copyright (C) 1999-2006 by  Zilog, Inc.
                           B     3    ;*  All Rights Reserved
                           B     4    ;**********************************************
                           B     5    
                           B   955    	.list on
                           B   956    
                           B   957    
                           A     5    ; Setup video generator
     017D7840              A     6    		sysFreq		equ		25_000_000;20_000_0
     00000032              A     7    		rFreq		equ		50
                           A     8    
     00000017              A     9    		hChars		equ		23			; Chara
     0000001E              A    10    		vChars		equ		30			; Chara
     00000002              A    11    		hBorderL	equ		2			; Left 
     00000002              A    12    		hBorderR	equ		2			; Right
     00000008              A    13    		cWidth		equ		8			; Width
     00000008              A    14    		cHeight		equ		8			; Heigh
                           A    15    
     00000002              A    16    		spiPre		equ	2
                           A    17    
                           B     0    include "monovideo4.inc"
                           B     1    ; Calculate timing parameters
     00000002              B     2    		leftChars	equ	2
     00000001              B     3    		rightChars	equ 1
     0000001A              B     4    		hCharsTotal equ	hChars + leftChars + ri
                           B     5    		if (hCharsTotal / 2) * 2 < hCharsTotal
                           B     6    			error "Horizontal characters must b
                           B     7    		endif
                           B     8    		
                           B     9    		if rFreq = 50
     00000040              B    10    			hTime		equ		64
     00000004              B    11    			hSyncTime	equ		4
     00000004              B    12    			bPorchTime	equ		4
     00000002              B    13    			fPorchTime	equ		2
     00000005              B    14    			vSyncHLines	equ		5
     00000001              B    15    			vSyncPad	equ		1;1
     00000120              B    16    			vLines		equ		288
                           B    17    		elseif rFreq = 60
                           B    18    			hTime		equ		63
                           B    19    			hSyncTime	equ		4
                           B    20    			bPorchTime	equ		4
                           B    21    			fPorchTime	equ		2
                           B    22    			vSyncHLines	equ		6
                           B    23    			vSyncPad	equ		240
                           B    24    			vLines		equ		
                           B    25    		else
                           B    26    			error	"Unknown frequency"
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   2


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.inc
                           B    27    		endif
                           B    28    
     0000003D              B    29    		t0Interval		var		hTime * sysFreq
     00000064              B    30    		t1hSync			equ		hSyncTime * sys
     000002B5              B    31    		t1BroadSync		equ		(t0Interval * (
                           B    32    
                           B    33    		;if t0Interval < (cWidth + 1) * spiPre 
                           B    34    		if hCharsTotal > (hTime * 25) / ((cWidt
                           B    35    			error "Horizontal character count t
                           B    36    		endif
                           B    37    		
                           B    38    ;Register labels (R4-R8 are free to use)
     00000001              B    39    		DDR			equ		1
     00000002              B    40    		AF			equ		2
                           B    41    
                           B    42    		vBuff		equ		RR10
                           B    43    		vBuffH		equ		R10
                           B    44    		vBuffL		equ		R11
                           B    45    		isrVect		equ		RR14
                           B    46    		isrVectH	equ		R14
                           B    47    		isrVectL	equ		R15
                           B    48    		hCharCnt	equ		R12
                           B    49    		vLineCnt	equ		R13
                           B    50    		state		equ		R9
     00000010              B    51    		lineBuff	equ		10h					     00000027              B    52    		userVars	equ		lineBuff + hChars	                           B    53    		
                           B    54    		
     00000200              B    55    		screenBuff	equ		200h
                           A    19    
0002 0200                  A    20    vector	RESET = init
000C 0298                  A    21    vector timer0 = isrT0
                           A    22    org 0200h
0200 8F                    A    23    init		di									0201 0100                  A    24    			srp		#00h						0203 E9000FFE              A    25    			ldx		SPH,#00h					0207 E9FF0FFF              A    26    			ldx		SPL,#FFh
020B 6C02                  A    27    			ld		R6,#2
020D D6 027F               A    28    			call	clrBuff						                           A    29    			
0210 E9010FD8              A    30    initSpi		ldx		PCADDR,#DDR					0214 E9EF0FD9              A    31    			ldx		PCCTL,#~(1<<4)
0218 E9020FD8              A    32    			ldx		PCADDR,#AF					021C E9100FD9              A    33    			ldx		PCCTL,#(1<<4)				0220 E9030F61              A    34    			ldx		SPICTL,#(1<<1)|(1<<0)		0224 E9000F63              A    35    			ldx		SPIMODE,#((cWidth & 7) << 2
0228 E9000F66              A    36    			ldx		SPIBRH,#HIGH(spiPre)		022C E9020F67              A    37    			ldx		SPIBRL,#LOW(spiPre)
                           A    38    
0230 E9000F07              A    39    			ldx		T0CTL1,#0					0234 E9000F06              A    40    			ldx		T0CTL0,#0					0238 E9000F02              A    41    			ldx		T0RH,#HIGH(t0Interval)		Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   3


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
023C E93D0F03              A    42    			ldx		T0RL,#LOW(t0Interval)		0240 E9010F07              A    43    			ldx		T0CTL1,#(1<<0)				0244 E9200FC1              A    44    			ldx		IRQ0ENH,#(1<<5)				0248 E9200FC2              A    45    			ldx		IRQ0ENL,#(1<<5)
                           A    46    			
024C E9000F0F              A    47    			ldx		T1CTL1,#0					0250 E9000F0E              A    48    			ldx		T1CTL0,#0					0254 E9000F0A              A    49    			ldx		T1RH,#HIGH(t1hSync)			0258 E9640F0B              A    50    			ldx		T1RL,#LOW(t1hSync)
025C E9400F0F              A    51    			ldx		T1CTL1,#(1<<6)				                           A    52    
0260 E9020FD8              A    53    initGPIO	ldx		PCADDR,#AF					0264 49020FD9              A    54    			orx		PCCTL,#(1<<1)			
                           A    55    			
0268 4CEE                  A    56    startVideo	ld		R4,#EEh
026A 5C19                  A    57    			ld		R5,#19h
026C 6C19                  A    58    			ld		R6,#19h
026E 9C 18                 A    59    			ld		state,#LOW(preEq)			0270 CC0B                  A    60    			ld		hCharCnt,#hCharsTotal/2 - l
0272 DC06                  A    61    			ld		vLineCnt,#vSyncHLines + vSy
0274 EC 03                 A    62    			ld		isrVectH,#HIGH(sync)
0276 FC 00                 A    63    			ld		isrVectL,#LOW(sync)
0278 49800F07              A    64    			orx		T0CTL1,#(1<<7)				027C 9F                    A    65    			ei									                           A    66    			
027D                       A    67    $$			; Do stuff
027D 8B FE                 A    68    			jr		$B
                           A    69    
027F 0C02                  A    70    clrBuff		ld		R0,#HIGH(screenBuff)
0281 1C00                  A    71    			ld		R1,#LOW(screenBuff)
0283 E4E1E2                A    72    $$			ld		R2,R1
0286 56E23F                A    73    			and		R2,#63
0289 96E2E0                A    74    			ldx		@RR0,R2
028C A0E0                  A    75    			incw	RR0
028E A6E1B2                A    76    			cp		R1,#LOW(screenBuff+hChars*v
0291 1FA6E004              A    77    			cpc		R0,#HIGH(screenBuff+hChars*
0295 EB EC                 A    78    			jr		ne,$B
0297 AF                    A    79    			ret
                           A    80    
0298 C4EE                  A    81    isrT0		jp		@isrVect
                           A    82    
                           A    83    align 256
0300                       A    84    sync
0300 FC 03                 A    85    backPorch	ld		isrVectL,#LOW(hSync)
0302 BF                    A    86    			iret
                           A    87    			
0303 59BF0F0F              A    88    hSync		andx	T1CTL1,#~(1<<6)				0307 49800F0F              A    89    			orx		T1CTL1,#(1<<7)				030B 49400F0F              A    90    			orx		T1CTL1,#(1<<6)
030F FC 12                 A    91    			ld		isrVectL,#LOW(frontPorch)
0311 BF                    A    92    			iret
                           A    93    
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   4


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
0312 E4E9EF                A    94    frontPorch	ld		isrVectL,state
0315 BCFF                  A    95    			ld		vBuffL,#FFh					0317 BF                    A    96    			iret
                           A    97    ; Pre-equalizing pulses
0318 CA 10                 A    98    preEq		djnz	hCharCnt,preEqEnd
031A DA 0A                 A    99    			djnz	vLineCnt,$F
031C 9C 2B                 A   100    			ld		state,#LOW(vertPad)			031E E4E5ED                A   101    			ld		vLineCnt,R5
0321 CC17                  A   102    			ld		hCharCnt,#hChars
0323 FC 00                 A   103    			ld		isrVectL,#LOW(sync)
0325 BF                    A   104    			iret
0326 CC0B                  A   105    $$			ld		hCharCnt,#hCharsTotal/2 - l
0328 FC 00                 A   106    			ld		isrVectL,#LOW(sync)
032A BF                    A   107    preEqEnd	iret
                           A   108    
                           A   109    ; Vertical padding
032B E9FF0F60              A   110    vertPad		ldx		SPIDATA,#FFh
032F CA 14                 A   111    			djnz	hCharCnt,vertPadEnd
0331 FC 00                 A   112    			ld		isrVectL,#LOW(sync)
0333 DA 0E                 A   113    			djnz	vLineCnt,$F
0335 9C 46                 A   114    			ld		state,#LOW(fetch)			0337 E4E4ED                A   115    			ld		vLineCnt,R4
033A CC17                  A   116    			ld		hCharCnt,#hChars
033C 2C02                  A   117    			ld		R2,#HIGH(screenBuff)		033E 3C00                  A   118    			ld		R3,#LOW(screenBuff)
0340 0C07                  A   119    			ld		R0,#7
0342 BF                    A   120    			iret
0343 CC17                  A   121    $$			ld		hCharCnt,#hChars
0345 BF                    A   122    vertPadEnd	iret
                           A   123    
                           A   124    
                           A   125    
                           A   126    ; Visible display
0346 94BF60                A   127    fetch		ldx		SPIDATA,vBuffL
0349 CA 20                 A   128    			djnz	hCharCnt,fetchTile			034B 26E317                A   129    			sub		R3,#hChars					034E 36E200                A   130    			sbc		R2,#0
0351 CC17                  A   131    			ld		hCharCnt,#hChars
0353 FC 00                 A   132    			ld		isrVectL,#LOW(sync)
0355 DA 06                 A   133    			djnz	vLineCnt,$F					0357 9C 7C                 A   134    			ld		state,#LOW(vertPad2)		0359 E4E6ED                A   135    			ld		vLineCnt,R6
035C BF                    A   136    			iret
035D E4EDE0                A   137    $$			ld		R0,vLineCnt
0360 56E007                A   138    			and		R0,#07h
0363 EB 06                 A   139    			jr		ne,$F						0365 06E317                A   140    			add		R3,#hChars					0368 16E200                A   141    			adc		R2,#0
036B                       A   142    $$
036B E4EDE0                A   143    fetchTile	ld		R0,vLineCnt
036E 56E007                A   144    			and		R0,#07h						0371 46E0 00               A   145    			or		R0,#HIGH(charSet)			Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   5


PC     Object              I  Line    Source C:\users\koen\MY_D~D41\src\ez8\MONO~MM3\monovideo4.asm
0374 86E2E1                A   146    			ldx		R1,@RR2						0377 A0E2                  A   147    			incw	RR2							                           A   148    			;ldc		vBuffL,@RR0				                           A   149    			;ld		vBuffL,vLineCnt
0379 BC00                  A   150    			ld		vBuffL,#00h					037B BF                    A   151    			iret
                           A   152    
                           A   153    
                           A   154    			
                           A   155    			
                           A   156    ; Vertical padding bottom
037C E9FF0F60              A   157    vertPad2	ldx		SPIDATA,#FFh
0380 CA 0D                 A   158    			djnz	hCharCnt,vertPad2End
0382 FC 00                 A   159    			ld		isrVectL,#LOW(sync)
0384 DA 07                 A   160    			djnz	vLineCnt,$F
0386 9C 90                 A   161    			ld		state,#LOW(postEq)			0388 DC05                  A   162    			ld		vLineCnt,#vSyncHLines
038A CC0B                  A   163    			ld		hCharCnt,#hCharsTotal/2 - l
038C BF                    A   164    			iret
038D CC17                  A   165    $$			ld		hCharCnt,#hChars
038F BF                    A   166    vertPad2End	iret
                           A   167    
                           A   168    ; Post-equalizing pulses
0390 CA 12                 A   169    postEq		djnz	hCharCnt,postEqEnd
0392 DA 0C                 A   170    			djnz	vLineCnt,$F
0394 9C A5                 A   171    			ld		state,#LOW(vSync)			0396 DC05                  A   172    			ld		vLineCnt,#vSyncHLines
0398 E9020F0A              A   173    			ldx		T1RH,#HIGH(t1BroadSync)		039C E9B50F0B              A   174    			ldx		T1RL,#LOW(t1BroadSync)
03A0 CC0B                  A   175    $$			ld		hCharCnt,#hCharsTotal/2 - l
03A2 FC 00                 A   176    			ld		isrVectL,#LOW(sync)
03A4 BF                    A   177    postEqEnd	iret
                           A   178    ; Broad sync pulses
03A5 CA 12                 A   179    vSync		djnz	hCharCnt,vSyncEnd
03A7 DA 0C                 A   180    			djnz	vLineCnt,$F
03A9 9C 18                 A   181    			ld		state,#LOW(preEq)			03AB DC06                  A   182    			ld		vLineCnt,#vSyncHLines + vSy
03AD E9000F0A              A   183    			ldx		T1RH,#HIGH(t1hSync)			03B1 E9640F0B              A   184    			ldx		T1RL,#LOW(t1hSync)
03B5 CC0B                  A   185    $$			ld		hCharCnt,#hCharsTotal/2 - l
03B7 FC 00                 A   186    			ld		isrVectL,#LOW(sync)
03B9 BF                    A   187    vSyncEnd	iret
                           A   188    
                           A   189    
                           A   190    if vSync - sync > 200
-----WARNING (507) Unexpected relocatable boolean/relational operand(s)
                           A   191    	warning "vSync label almost out of reach!"	                           A   192    endif											                           A   193    			
                           A   194    xref charSet
Zilog eZ8 Encore! Macro Assembler Version 2.53 (14010603) 05-Jul-15     20:23:32     page:   6


PC     Object              I  Line    Source 


Errors: 0
Warnings: 1
Lines Assembled: 2359
